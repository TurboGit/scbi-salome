
function s-salome-tar-tar()
{
    local VERSION=$1

    # VERSION is : <SALOME_VERSION>:<OS>

    local VER=${VERSION/:*}
    local OS=${VERSION/*:}

    echo edf
    echo wget
    echo https://minio.retd.edf.fr/salome/Releases/development/CEA_archive
    echo SALOME-$VER-$OS-SRC.tar.gz
}

function s-salome-tar-out-of-tree()
{
    echo false
}

function s-salome-tar-env()
{
    local PREFIX=$1
    local TARGET=$2
    local VARIANT=$3

    local BINDIR=$(basename $(ls -1d $PREFIX/BINARIES-*))

    set-var SALOME_BIN_APPLICATION $PREFIX
    set-var SALOME_BIN_MODULES     $PREFIX/$BINDIR
}

function s-salome-tar-install()
{
    local PREFIX=$1
    local TARGET=$2
    local VARIANT=$3

    #  Copy the tarball content into the application directory. This will
    #  be the part changed (see below) and used to create the new installer.

    dlog salome-tar Init SALOME sources

    cd ..
    ln -s build $PREFIX

    dlog salome-tar Fix some paths

    #  Remove CONFIGURATION setting from env_launch.sh
    #  The configuration is not part of the binary archive so
    #  we use our own checkout.

    sed -i 's/^export\(.*CONFIGURATION_ROOT_DIR.*\)/# export \1/g' \
        $PREFIX/env_launch.sh
    sed -i 's/    context\.\(.*CONFIGURATION_ROOT_DIR.*\)/#    context.setVariable(r"\1/g' \
        $PREFIX/salome

    #  Fix PATH in CMake pointing to the build-time environment

    #  ??? Note that this part may be tricky as we really want to replace
    #  individual strings.
    #  In "/volatile/.../INSTALL/dir1:/volatile/.../INSTALL/dir2" we don't
    #  want to replace by /new/path/dir2 because sed regular expressions
    #  are greedy. So we break the strings match using : ; or back-slash.

    local ORIGDIR="/volatile/[^:;\"]*SALOMEBuilder/[^/]*/INSTALL"

    local BINDIR=$(basename $(ls -d $PREFIX/BINARIES-*))

    find $PREFIX/ -type f -name "*.cmake" |
        while read F; do
            sed -i "s,$ORIGDIR/,$PREFIX/$BINDIR/,g" $F
        done

    #  Fix wrong libtbb PATH pointing to the build-time environment

    find $PREFIX/$BINDIR/openturns -name "*.cmake" \
         -exec sed -i 's,"/lib/x86_64-linux-gnu/libtbb.so,"/usr/lib/x86_64-linux-gnu/libtbb.so,g' {} \;

    #  Fix path (shebang) in bin/sip* scripts (not needed in Scibian-10)

    find $PREFIX/$BINDIR/sip/bin -type f -name "*sip*" |
        while read F; do
            sed -i "s,$ORIGDIR/,$PREFIX/$BINDIR/,g" $F
        done
}

function s-salome-tar-prefix()
{
    echo NONE
}
