#!/bin/bash

source $(dirname ${BASH_SOURCE[0]})/install-setup-common

AUTO=0

function desktop-icon()
{
    local PREFIX=$1
    local APPLIDIR_PATH=$HOME/.local/share/applications
    local DESKTOP_FILE_NAME=Salome_template.desktop
    local DESKTOP_FILE_VERSION=Salome_V__SALOMEVERSION__.desktop
    local DESKTOPDIR=$(xdg-user-dir DESKTOP)

    mv $PREFIX/$DESKTOP_FILE_NAME $PREFIX/$DESKTOP_FILE_VERSION
    ICONE_FILE=$PREFIX/icon.png

    # de YAMM projects/salome/installer/strings_template.py&

    # Install the menu and desktop files if requested
    if test -e $PREFIX/$DESKTOP_FILE_VERSION; then
      sed -i "s#APPLIDIR#$PREFIX#g" $PREFIX/$DESKTOP_FILE_VERSION
      sed -i "s#VERSION#__SALOMEVERSION__#g" $PREFIX/$DESKTOP_FILE_VERSION
    fi

    if [[ -e $PREFIX/$DESKTOP_FILE_VERSION ]] ; then
      if [[ ! -d $APPLIDIR_PATH ]] ; then
        mkdir -p $APPLIDIR_PATH  || die "mkdir failed"
      fi
      cp $PREFIX/$DESKTOP_FILE_VERSION $APPLIDIR_PATH/
      chmod +x $APPLIDIR_PATH/$DESKTOP_FILE_VERSION
    fi

    if test -n $DESKTOPDIR; then
      if test -e $PREFIX/$DESKTOP_FILE_VERSION; then
        cp $PREFIX/$DESKTOP_FILE_VERSION $DESKTOPDIR
        chmod +x $DESKTOPDIR/$DESKTOP_FILE_VERSION
      fi
    fi
}

while [ ! -z $1 ]; do
    case "$1" in
        --auto)
            AUTO=1;
            break;
            ;;
        *)
            ;;
    esac
    shift;
done

# check for python3
#
if [ -z "$(python --version 2>&1 | grep ' 3\.')" ]; then
   echo Python2 is default, checking for python3
   if [ -f /usr/bin/python3 ]; then
      echo Found Python3 in /usr/bin/python3, setup links
      ln -s /usr/bin/python3 bin/python
      ln -s /usr/bin/python3 bin/salome/python
   else
      echo Cannot found a Python3 installation.
      echo SALOME will not work properly.
   fi
fi

# Add icon link on desktop
desktop-icon $PWD

# In auto-mode, do nothing more
[[ $AUTO = 1 ]] && exit 0

SUDO=""

echo Installing SALOME

prefix=$(get-install-directory \$HOME/opt/salome)

check-writable $prefix || SUDO=sudo

$SUDO mkdir -p $prefix
$SUDO cp -r * .[a-z]* $prefix/

$SUDO rm -f $prefix/setup

$SUDO chown $USER -R $prefix

cd $prefix

# fix paths in config_appli.xml
sed -i "s,/home.*install,$prefix,g" config_appli.xml
sed -i "s,/home.*application,$prefix,g" config_appli.xml

# Setup the HPC servers, the template file servers.pvsc
# will be used by the following script to create or update
# the file $HOME/.config/ParaView
./salome_hpc_visu_servers.py

echo "SALOME installation terminated, to start:"
echo "$ $prefix/salome"
